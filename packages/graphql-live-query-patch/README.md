# @n1ru4l/graphql-live-query-patch

[![npm version](https://img.shields.io/npm/v/@n1ru4l/graphql-live-query-patch.svg)](https://www.npmjs.com/package/@n1ru4l/graphql-live-query-patch) [![npm downloads](https://img.shields.io/npm/dm/@n1ru4l/graphql-live-query-patch.svg)](https://www.npmjs.com/package/@n1ru4l/graphql-live-query-patch)

Make your live query payload smaller with json patches.

If you have big live query operations you might opt into only sending JSON patches to your clients. This requires the server to always store the latest execution result. When a new execution result is published a JSON patch is generated by diffing those execution results.
The resulting patch operations are then sent to the client where they are applied to the initial execution result.

For example usage check out the todo-example client & server code.

## Install Instructions

```bash
yarn add -E @n1ru4l/graphql-live-query-patch
```

## API

### `createLiveQueryPatchGenerator`

```ts
import { execute } from "graphql";
import { createLiveQueryPatchGenerator } from "@n1ru4l/graphql-live-query-patch";
import { schema } from "./schema";

execute({
  schema,
  operationDocument: parse(/* GraphQL */ `
    query todosQuery @live {
      todos {
        id
        content
        isComplete
      }
    }
  `),
  rootValue: rootValue,
  contextValue: {},
  variableValues: null,
  operationName: "todosQuery",
}).then(async (result) => {
  if (isAsyncIterable(result)) {
    const makePatches = createLiveQueryPatchGenerator();
    for (const value of makePatches(result)) {
      console.log(value);
    }
  }
});
```

### `createApplyLiveQueryPatchGenerator`

Convenience wrapper for applying `createLiveQueryPatchGenerator` on the `execute` return value.

```ts
import { execute } from "graphql";
import { applyLiveQueryPatchDeflator } from "@n1ru4l/graphql-live-query-patch";
import { schema } from "./schema";

const applyLiveQueryPatchGenerator = createApplyLiveQueryPatchGenerator();

const result = applyLiveQueryPatchGenerator(
  execute({
    schema,
    operationDocument: parse(/* GraphQL */ `
      query todosQuery @live {
        todos {
          id
          content
          isComplete
        }
      }
    `),
    rootValue: rootValue,
    contextValue: {},
    variableValues: null,
    operationName: "todosQuery",
  })
);
```

### `createApplyLiveQueryPatch`

Inflate the execution result on the client side.

```ts
import { createApplyLiveQueryPatch } from "@n1ru4l/graphql-live-query-patch";

const applyLiveQueryPatch = createApplyLiveQueryPatch();

const asyncIterable = applyLiveQueryPatch(
  networkLayer.execute({
    operation: /* GraphQL */ `
      query todosQuery @live {
        todos {
          id
          content
          isComplete
        }
      }
    `,
  })
);
```
